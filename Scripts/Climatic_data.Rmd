---
title: "Climatic_data"
author: "Thomas Francisco"
date: "2024-04-29"
output:
  html_document:
    number_sections: true #titles
    toc: true #table of content
    toc_float: true # enable the toc to be on the side of the text, always visible
    collapsed: True #control if the toc label will only display top level titles
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = FALSE)

#rm(list = ls()) 
library(dplyr) 
library(tidyverse)
library(ggplot2)
library(corrplot)  
library(dismo)
library(raster)
library(vegan)
library(plyr)
library(writexl)
library(rasterize)
library(sf)
library(FactoMineR)
```

# Introduction

This script processes climatic and environmental data from the raw output of ClimateDT (or any program providing raster TIFF data) into a dataframe containing standardized values for the selected variables under past, present, and future climatic conditions. High-resolution climatic data (30 arc-seconds) were obtained from the **Climate Downscaling Tool (ClimateDT; Marchi et al., 2024)**, a dynamic web tool that provides elevation-adjusted historical and future climatic data. The period 1901–1950 was used as the reference for local adaptation of populations, and the period 2041–2060 was used as the future scenario, with mean values derived from five global climate models (GCMs) under the socio-economic pathway SSP3-7.0.  

To identify the final set of climatic predictors for downstream analyses, we first focused on a pre-selected set of variables relevant to the species’ ecology. For past climatic data, forward selection was performed using the ordiR2step function from the vegan R package (Oksanen et al., 2001) to identify variables most closely related to genomic variation across populations. Next, variables with high collinearity (correlation coefficient > 0.75) were removed, prioritizing retention of the most informative variables identified during forward selection. Finally, variance inflation factors (VIFs) were calculated, and additional variables were removed to ensure VIF values were below 10.  

After these selection steps, the retained climatic variables were standardized, and the processed datasets for past, present, and future scenarios were exported in multiple formats for downstream analyses.  

```{r meta data}
meta_data_pop <- read.csv("C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Populations/taxus_sample_29pop.csv",h=T,sep=";",dec=",")
meta_data_vcf <- read.csv("C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/samples/samples_taxus_baccata_adapcon_gentree.csv",h=T,sep=";",dec=",")
```

# Pre-selection of climatic variables


he first step involved reviewing the literature on the target species to define a set of climatic variables that could potentially drive adaptive genetic variation across its range. The aim was to retain only biologically informative variables, reducing the number of predictors tested and allowing refinement of hypotheses prior to analysis. The goal was not to limit the dataset to only 2–3 variables, nor to retain all available variables, but to pre-select a moderate set—typically 10–15 variables depending on the species and the depth of relevant literature.

For *T. baccata*, the initial pre-selection included the following variables: **Bio 1, 2, 3, 4, 5, 6, 7, 9, 10, 12, 13, 14, 15, 16, 17, 18, MGSP, AHM, SHM**.
  
# Climatic data

## Data

Climatic data were obtained from ClimateDT in two formats: point layers and rasters, for both past and future conditions. A key difference between past and future data lies in their temporal resolution:  

Past data provide one value per year for each variable at each population/pixel. For example, for 1901–1950, there are 50 values per variable per population.  

Future data are less detailed, providing only mean values for the selected period; for example, 2041–2070 has one value per variable per population.  

Many bioclimatic variables (Bio1–Bio19) are derived from monthly minimum temperature (tmin), maximum temperature (tmax), and precipitation. Therefore, the average of yearly Bio1 values cannot be directly calculated for a period. Instead, tmin, tmax, and precipitation are averaged for each month across the period (e.g., one tmin value for January, one for February, etc.). These monthly averages are then used with the biovars function from the Dismo R package to calculate the 19 bioclimatic variables for the period of interest (e.g., 1901–1950). Other derived variables, such as AHM, can be calculated following the ClimateDT procedures using Bio1, Bio10, and Bio12 values from biovars.  

For variables not directly linked to tmin, tmax, precipitation, or bioclimatic variables (e.g., GDD5), obtaining period-specific averages is less straightforward, thus these data were provided directly by Maurizio Marchi (IBBR-CNR).  

It is important to note that future climatic predictions can vary depending on the model used. To avoid bias from extreme model predictions, mean values from multiple models can be used; however, accessing multiple models is only possible via raster data.

Based on previous testing with the script *Processing_climatic_data_T_adapcon_Gentree_bis*, differences between point layers and raster data were significant for temperature-related variables. Therefore, we used raster data for the 1901–1950 period to maintain consistency with future raster-based predictions and avoid discrepancies due to the data extraction method

Load past climatic data 
```{r load past raster data}
#Create an R object where all the climatic rasters are.
ras.bio <- stack(list.files("C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/1901-1950_raster/", pattern = ".tif$", full.names = T)) 
#Names of the raster (because they are not in the classic order Bio 1, 2 etc they are order by number so bio 1, 10, 11 etc)
names(ras.bio) <- unlist(strsplit(unlist(lapply(strsplit(list.files("C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/1901-1950_raster/", pattern = ".tif$", full.names = T), split = "C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/1901-1950_raster/"), function(x) x[2])), split = ".tif"))

#We extracted the climatic values for each populations from the raster based on their coordinates
coords<- data.frame(apply(meta_data_pop[,c(5:4)], 2, as.numeric))#We need to have longitude then latitude
past_climatic_data_raster <- data.frame(meta_data_pop$Population,raster::extract(ras.bio, coords))#Use raster::function_name to avoid confusion with tidyr functions that have the same name
colnames(past_climatic_data_raster)<- c("Population",names(ras.bio))

#Add country info 
past_climatic_data_f <- merge(meta_data_pop[,c(1,2)],past_climatic_data_raster, "Population")
```


```{r save past raster for GO RDA, include=FALSE}
#Save the raster for RDA GO
past_climatic_data_raster <- ras.bio
save(past_climatic_data_raster,file="C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Genomic_offset/RDA/past_climatic_data_raster.Rdata")
```

## Climatic variations among populations
      
```{r violin plot in a loop}
#Do the violin plot in a loop for each climatic variables

#Input data for the loop
data <- past_climatic_data_f
regions <-past_climatic_data_f$Country
bioclim_vars <- c("bio1", "bio2", "bio3", "bio4","bio5","bio6","bio7","bio9", "bio10","bio12","bio13","bio14","bio15","bio16", "bio17", "bio18","AHM", "MGSP", "SHM", "GDD5")
unit_var <- c("°c","°c","index","°c","°c","°c","°c","°c","°c","mm","mm","mm","index","mm","mm","mm","°c/mm","mm","°c/mm","°c*days" )

#Results: the loop
for (x  in 1:length(bioclim_vars)) {
  var <- bioclim_vars[x]
   unit <- unit_var[x]
  data_subset <- data.frame(data[, paste0(var)]) #For each variable in bioclim_vars, we extract the two periods and created a data.frame with only these two variables. 
  colnames(data_subset) <- c("var1")
  #This create scatterplot to compare the bioclimatic variable between the two periods
  plot <- ggplot(data_subset, aes(x =var,y= var1)) +#War is the values and var1 is just the name of the variable 
  geom_violin(trim = FALSE) +
  geom_point(aes(color = regions), shape = 16, position = position_jitter(seed = 1, width = 0.2)) +
  labs(colour="Countries",x="variable",y=paste0("values ","(",unit,")"),title=paste0("Violin Plot of ",var," differences across populations"))+
  theme(plot.title = element_text(hjust = 0.5))
  
  #Save
png(paste0("C:/Users/tfrancisco/Documents/Thesis/Results/species/taxus/climate/past_climatic_data/violin_plot/violin_plot_",var,".png"));print(plot)
;dev.off()
}
```

Example of violin plot: 

```{r example of violin plot for the html, echo=FALSE}
data <- past_climatic_data_f
regions <-past_climatic_data_f$Country
bioclim_vars <- c("bio1", "bio4","bio12","bio15")
unit_var <- c("°c","°c","mm","mm" )

for (x  in 1:length(bioclim_vars)) {
  var <- bioclim_vars[x]
   unit <- unit_var[x]
  data_subset <- data.frame(data[, paste0(var)])
  colnames(data_subset) <- c("var1")
  plot <- ggplot(data_subset, aes(x =var,y= var1)) +
  geom_violin(trim = FALSE) +
  geom_point(aes(color = regions), shape = 16, position = position_jitter(seed = 1, width = 0.2)) +
  labs(colour="Countries",x="variable",y=paste0("values ","(",unit,")"),title=paste0("Violin Plot of ",var," differences across populations"))+
  theme(plot.title = element_text(hjust = 0.5))
  print(plot)
}
```

Interpretation: We observed differences in climatic values across populations, suggesting that local adaptation could arise between populations, as distinct climatic selective pressures appear to affect different populations.  

  
# Selection of climatic data  
  
The selection of climatic variables was considered through three more steps:  
  
 
## Imprecision along studied area
      
The accuracy of climatic variables is not uniform across the study area or among variables themselves. If uncertainty layers were available, variables with high inaccuracy could be removed. However, this assessment was not feasible for the present study.
 
## Explained variance

To identify which climatic variables explain the most genetic variation, we conducted a Redundancy Analysis (RDA; see RDA_candidate_detection script for details). Using the **ordiR2step** function from the vegan R package, we started with a null model containing no explanatory variables and progressed to a full model including all potential explanatory variables. Variables were retained based on their significance in increasing model R², using a p-value threshold of < 0.05 over 1,000 permutations. The most important variables explaining genomic variation were identified, and twenty independent runs were conducted to assess the consistency of variable detection.

```{r genomic data}
#Genomic data
load("C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/genetic_new/data_allelic_frequencies_29pop_adapcon_gentree_475_8616.Rdata")
genomic_matrix <- data_allelic_frequencies_29pop_adapcon_gentree_475_8616
```

Climatic variables were scaled to standardise their range and variance prior to downstream analyses
```{r scale}
past_climatic_data_scale <- past_climatic_data_f[,-c(1,2)]%>%
  apply(2,as.numeric) %>% as.data.frame %>% 
mutate(across(where(is.numeric), scale))
```

We can perform the RDA:
```{r RDA, eval=F, echo=T}
#Null model
RDA_null <- rda(genomic_matrix~1,past_climatic_data_scale )

#Model with all the variables
RDA_full <- rda(
formula=genomic_matrix~bio1+bio2+bio3+bio4+bio5+bio6+bio7+bio9+bio10+bio12+bio13+bio14+bio15+bio16+bio17+bio18+AHM+MGSP+SHM+GDD5,data = past_climatic_data_scale,scale=F)

#Stepwise by selecting only variables that increase the adjusted R^2 of the model and that have a pvalue lower than 0.05
Variable_selection_pv0.05 <- ordiR2step(RDA_null, RDA_full, Pin = 0.05, R2permutations = 1000, R2scope = T)

#Variable_selection_pv0.05$anova
names(Variable_selection_pv0.05$CCA$envcentre)

#we want, following Archambeau et al 2024, investigate if the permutation stepwise identified the same variables of interest depending on the run:
#we run 20 independent stepwise models.
nbmodels <- 20

# Stepwise selection with ordiR2step function
#rep20_variable_selec_pv0.05 <- lapply(1:nbmodels, function(x) {
  #mod <- ordiR2step(RDA_null, RDA_full, Pin = 0.05, R2permutations = 1000, R2scope = T)
  #return(names(mod$CCA$envcentre))}) %>% 
  #setNames(paste0("model",1:nbmodels)) %>% 
  #ldply(function(x) data.frame(variables=x),.id="models") %>%  
  #dplyr::summarise(count(variables)) %>% 
  #setNames(c("variable","count"))
```

```{r save and load rep ordi2steps, include=FALSE}
#save(rep20_variable_selec_pv0.05, file="C:/Users/tfrancisco/Documents/Thesis/Results/species/taxus/climate/selection_var/rep20_variable_selec_pv0.05.Rdata")

load("C:/Users/tfrancisco/Documents/Thesis/Results/species/taxus/climate/selection_var/rep20_variable_selec_pv0.05.Rdata")
```

```{r see rep20_variable_selec_pv0.05}
rep20_variable_selec_pv0.05
```

Interpretation: Bio2, Bio4, Bio7, and Bio9 appear to be important climatic variables. They were consistently identified in all 20 runs of the ordiR2step analysis, each contributing to an increase in model R² with p-values < 0.05.


## Multicollinearity Between Variables

To reduce multicollinearity, only variables with low pairwise correlation were retained. Specifically, variables with an absolute correlation coefficient < 0.75 were kept from the pre-selected set of climatic variables.

```{r multicollinearity between variables}
#Function to do it
#Matrix of correlation
correlation_function <-function(data,threshold){
    data_correlation <- subset(data,select= -c(Population,Country)) 
      rownames(data_correlation) <- data$Populations
      correlation <- cor(data_correlation)
  correlation[abs(correlation) <= threshold] <- 0
corr_plot <- corrplot(correlation, method = "number", addrect = 2, col = c("red", "white", "red"), type = "lower", tl.col = "black", tl.cex = 0.6, number.cex = 0.6)
#Save
png("C:/Users/tfrancisco/Documents/Thesis/Results/species/taxus/climate/selection_var/corrplot_multicollinearity.png");corr_plot <- corrplot(correlation, method = "number", addrect = 2, col = c("red", "white", "red"), type = "lower", tl.col = "black", tl.cex = 0.6, number.cex = 0.6);dev.off()

#Plot the corrplot
corr_plot
}

#Right order
past_climatic_data_order <- past_climatic_data_f[,c(1,2,4,13:19,5:12,3,20,21,22)]

#Correlation past/present
data_present <- past_climatic_data_order
threshold <- 0.75
correlation_past <-correlation_function(data_present,threshold)
```

Conclusion: Based on the correlation among variables and prior identification of the most important predictors of genetic variation, we selected **BIO1, BIO2, BIO3, BIO4, BIO5, BIO9, BIO12, and BIO15.**

## Variance inflation factor (VIF) 
      
To further reduce multicollinearity, we calculated the variance inflation factor (VIF) for the retained variables, ensuring that no highly correlated variables were included in the final dataset.
```{r VIF}
#Subset previous step
RDA_subset_step4 <- rda(formula=genomic_matrix~bio1+bio2+bio3+bio4+bio5+bio9+bio12+bio15,data = past_climatic_data_scale,scale=F)
#anova.cca(RDA_subset_step4)
#RsquareAdj(RDA_subset_step4)
##Vif
vif.cca(RDA_subset_step4)
```

We observed that the VIF for some variables in the subset from previous step was excessively high (e.g., over 160 for BIO2). Considering this and the importance of certain variables for explaining genetic variation, we adjusted the subset to ensure that all VIF values were below 10.

```{r final set}
#Adjusted subset based on VIF
RDA_adjusted_subset <- rda(formula=genomic_matrix~bio1+bio2+bio4+bio9+bio12+bio15,data = past_climatic_data_scale,scale=F)
#anova.cca(RDA_adjusted_subset)
#RsquareAdj(RDA_adjusted_subset)
##Vif
vif.cca(RDA_adjusted_subset)
```

Interpretation: By removing BIO5 and BIO3, we successfully reduced the VIF for all retained variables to below 10 (even below 3).

Conclusion: we retained the subset: **Bio 1, 2, 4, 9, 12, 15** :
    - Bio 1: Mean annual Temperature (°C)
    - Bio 2: Mean Diurnal Range (Mean of monthly (max temp - min temp)) (°C)
    - Bio 4: Temperature Seasonality (standard deviation x100) (°C)
    - Bio 9: Mean Temperature of Driest Quarter (°C)
    - Bio 12: Mean annual Precipitation (mm)
    - Bio 15: Precipitation Seasonality (mm)
    
    
# Retained climatic data other periods

Based on the climatic variable selection, the following variables were retained for present and future periods: **Bio 1, 2, 4, 9, 12, 15**

## Present

```{r load present raster data}
#Create an R object where all the climatic rasters are.
ras.bio_present <- stack(list.files("C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/1991-2020_raster_climateDT/", pattern = ".tif$", full.names = T)) 
#Names of the raster (because they are not in the classic order Bio 1, 2 etc they are order by number so bio 1, 10, 11 etc)
names(ras.bio_present) <- unlist(strsplit(unlist(lapply(strsplit(list.files("C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/1991-2020_raster_climateDT/", pattern = ".tif$", full.names = T), split = "C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/1991-2020_raster_climateDT/"), function(x) x[2])), split = ".tif"))

#We extracted the climatic values for each populations from the raster based on their coordinates
coords<- data.frame(apply(meta_data_pop[,c(5:4)], 2, as.numeric))#We need to have longitude then latitude
present_climatic_data_Adapon_pop <- data.frame(meta_data_pop$Population,raster::extract(ras.bio_present, coords))#Important to add raster:: because this function is also in tidyr and will not do the same things
colnames(present_climatic_data_Adapon_pop)<- c("Population",names(ras.bio_present))

#Add country info 
present_climatic_data_Adapon_pop_f <- merge(meta_data_pop[,c(1,2)],present_climatic_data_Adapon_pop, "Population")

#Order
Present_new_6_Climatic_data_scale <-present_climatic_data_Adapon_pop_f[,c(1,2,3,6:8,4,5)]

#Name bio 
colnames(Present_new_6_Climatic_data_scale) <- c("Population","Country","Annual_Tc","Diurnal_range_Tc","Tc_Seasonality","Tc_driest_quarter","Annual_P","P_Seasonality")
```


##Future Climatic Data

Multiple climatic models are available for future projections. Selecting a single model without prior information could lead to bias, as predictions can differ substantially among models (Archambeau et al. 2024). To reduce this risk, we selected five widely used models for the 2041–2070 period under the SSP3-7.0 scenario:  
    - GFDL-ESM4  
    - IPSL-CM6A-LR  
    - MPI-ESM1-2-HR 
    - MPI-ESM2-0  
    - UKESM1-0-LL  

The first step involved loading the future climatic data for each of the selected climatic models.
```{r load future climatic data}
#List of the model for the loop
list_models<- c("GFDL_ESM4","IPSL_CM6A_LR","MPI_ESM1_2_HR","MRI_ESM2_0","UKESM1_0_LL") 

for(x in 1:length(list_models)){
  
  model <- list_models[x]
#Create an R object where all the climatic rasters are
ras.bio_future <- stack(list.files(paste0("C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/Future_climate/2041_2070_",model,"_ssp370/"), pattern = ".tif$", full.names = T)) 
#Names of the raster (because they are not in the classic order Bio 1, 2 etc they are order by number so bio 1, 10, 11 etc)
names(ras.bio_future) <- unlist(strsplit(unlist(lapply(strsplit(list.files(paste0("C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/Future_climate/2041_2070_",model,"_ssp370/"), pattern = ".tif$", full.names = T), split = paste0("C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/Future_climate/2041_2070_",model,"_ssp370/")), function(x) x[2])), split = ".tif"))

future_climatic_data <- data.frame(meta_data_pop$Population,raster::extract(ras.bio_future, coords))
colnames(future_climatic_data)=c("Population",names(ras.bio_future))
new_colnames<- paste(colnames(future_climatic_data[,-1]),model, sep = "_")
colnames(future_climatic_data)[-1] <- new_colnames

#Add country info 
future_climatic_data_f <- merge(meta_data_pop[,c(1,2)],future_climatic_data, "Population")
assign(paste0("Future_data_",model), future_climatic_data_f)
}
```


The next step involved grouping the data by climatic variable across all selected climatic models.
```{r creata 1 df per bio}
#List of the climatic var
list_climatic_var <- c("bio1","bio12","bio15","bio2","bio4","bio9")

for(x in 1:length(list_climatic_var)){
  climatic_var <- list_climatic_var[x]
  
  pos_clim <- x+2
  
#Climatic_values_ff <- Future_data_GFDL_ESM4[,x]
  
  data_set_clim <- data.frame(Population=Future_data_GFDL_ESM4$Population,Country=Future_data_GFDL_ESM4$Country,Future_data_GFDL_ESM4[,pos_clim],Future_data_IPSL_CM6A_LR[,pos_clim],Future_data_MPI_ESM1_2_HR[,pos_clim],Future_data_MRI_ESM2_0[,pos_clim],Future_data_UKESM1_0_LL[,pos_clim])
  
  colnames(data_set_clim)<- c("Population","Country",paste0(climatic_var,"_GFDL_ESM4"),paste0(climatic_var,"_IPSL_CM6A_LR"),paste0(climatic_var,"_MPI_ESM1_2_HR"),paste0(climatic_var,"_MRI_ESM2_0"),paste0(climatic_var,"_UKESM1_0_LL"))
  
  assign(paste0(climatic_var,"_future_climatic_data"),data_set_clim)
}
```


Next, we generated violin plots of the climatic values for each population across the different climatic models. One plot was created for each bioclimatic variable of interest.
```{r plot the variation across models, message=FALSE, warning=FALSE}
#Input data for the loop
unit_var <- c("°c","mm","Coefficient of Variation","°c","sd°c x100","°c")
list_dataset <- c("bio1_future_climatic_data","bio12_future_climatic_data","bio15_future_climatic_data","bio2_future_climatic_data","bio4_future_climatic_data","bio9_future_climatic_data")

#Results: the loop
for (x  in 1:length(list_dataset)) {
  
  dataset <- get(list_dataset[x])
   unit <- unit_var[x]
var_name <- list_climatic_var[x]
  
data_violin <- gather(dataset,key="dataset",value="Value",-Population,-Country)

#Add the name of the model 
data_violin_f <- data_violin %>%
  mutate(models = gsub("^[^_]+_", "", dataset))

#Create scatterplot to compare the bioclimatic variable between the two periods
  plot <- ggplot(data_violin_f, aes(x = models,y= Value)) +
  geom_violin(trim = FALSE) +
  geom_point(aes(color = data_violin_f$Country), shape = 16, position = position_jitter(seed = 1, width = 0.2),size=2) +
  labs(colour="Country",x=var_name,y=paste0("values ","(",unit,")"),title=paste0("Violin Plot of ",var_name," differences across climatic models"))+
  theme_classic() +  #Removes the grey background
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title.x = element_text(size = 16),
    axis.title.y = element_text(size = 16),
    axis.text.x = element_text(size = 8.3),
    axis.text.y = element_text(size = 12),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.key = element_rect(fill = "transparent", color = NA),
    panel.grid.major = element_line(color = "grey"),  
    panel.grid.minor = element_line(color = "grey"), 
    panel.grid.major.x = element_line(color = "grey"), 
    panel.grid.major.y = element_line(color = "grey")
  ) +
     scale_x_discrete(labels = c("label1" = "name1", "label2" = "name2")) +
    guides(color = guide_legend(override.aes = list(size = 4))) #Increase legend point size
  
#Save
pdf(paste0("C:/Users/tfrancisco/Documents/Thesis/Results/species/taxus/climate/future_climatic_data/violin_plot_comp_models/Comparison_",var_name,"between_climatic_models.pdf"));print(plot)
;dev.off()

#Print the plot
  print(plot)
}
```


Although some differences between climatic models are visible, the values are generally similar. To quantify this similarity, we calculated a correlation matrix among the models.

```{r correlation values across climatic models, message=FALSE, warning=FALSE}
list_names <- c("Bio 1","Bio 12","Bio 15","Bio 2","Bio 4","Bio 9")
for(x in 1:length(list_dataset)){
  df <- get(list_dataset[x])
  
  df_num <- df[,-c(1,2)] %>% mutate(across(as.numeric))
  
  #Names of the corr matrix for each biovariable
  names_corr <- paste0("correlation_",list_dataset[x])
  #Title of corrplot
  title <- (paste0("Correlation ",list_dataset[x]))
  
  name_title <- list_names[x]
  
  #Group for each bio var with the values of Bayes factor only 
corr_bio <- cor(df[, grepl("bio", names(df))]) 

#Name the corr_bio with names_corr
assign(names_corr,corr_bio)

names_corr
#Plot corrplot
corr_plot <- corrplot(get(names_corr), method = "number", addrect = 2, col = c("red", "white", "red"), type = "lower", tl.col = "black", tl.cex = 0.8, number.cex = 0.7,mar=c(0,0,1,0),title=paste0("Correlation ",name_title," future climatic data"))

#Save
pdf(paste0("C:/Users/tfrancisco/Documents/Thesis/Results/species/taxus/climate/future_climatic_data/Correlation/correlation_",list_dataset[x],".pdf"));corr_plot <- corrplot(get(names_corr), method = "number", addrect = 2, col = c("red", "white", "red"), type = "lower", tl.col = "black", tl.cex = 0.8, number.cex = 0.7,mar=c(0,0,1,0), title=paste0("Correlation ",name_title," future climatic data"));dev.off()
}
```

Climatic values were generally similar across models, except for **BIO9**, where the **UKESM1-0-LL model** predicted values that were inconsistent with the other models. This highlights the importance of caution when selecting future climatic values in the absence of prior information favoring one model. For subsequent analyses, we used all five climatic models to calculate genomic offset (GO) and compare predictions.

# Standardisation of the retained climatic variables
  
The final step involved creating a data frame with the retained climatic variables standardised for downstream analyses. Present and future climatic values were standardised using the past data as a reference, allowing comparisons of values to build indices such as the genomic discrepancy index or Genomic Offset between periods.

## Past data 

```{r normalize the past data, message=FALSE, warning=FALSE}
#Dataframe not scaled
Past_clim_data_Europe_pop <- past_climatic_data_order[,c(1:4,6,10,12,15)]
#Creation of the scaled matrix
Past_new_6_Climatic_data_scale <-past_climatic_data_order[,c(3,4,6,10,12,15)] %>% 
    scale()

Past_new_6_Climatic_data_scale_df <- data.frame(past_climatic_data_order[,c(1,2)],Past_new_6_Climatic_data_scale)

colnames(Past_new_6_Climatic_data_scale_df) <- c("Population","Country","Annual_Tc","Diurnal_range_Tc","Tc_Seasonality","Tc_driest_quarter","Annual_P","P_Seasonality")

df_to_scale <- past_climatic_data_order[,c(3,4,6,10,12,15)]
colnames(df_to_scale) <- c("Annual_Tc","Diurnal_range_Tc","Tc_Seasonality","Tc_driest_quarter","Annual_P","P_Seasonality")

  scale_env_value_new_cli <- attr(scale(df_to_scale), 'scaled:scale')
center_env_value_new_cli <- attr(scale(df_to_scale), 'scaled:center') 
```

```{r save past climatic data, include=FALSE}
#Save the matrix and the normalized values
#Non scaled data
save(Past_clim_data_Europe_pop,file="C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Climatic_data/new_selection/Past_clim_data_Europe_pop.Rdata" )

#Scaled data
write_xlsx(Past_new_6_Climatic_data_scale_df,"C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Climatic_data/new_selection/Past_new_6_Climatic_data_scale_df.xlsx")
save(Past_new_6_Climatic_data_scale_df,file="C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Climatic_data/new_selection/Past_new_6_Climatic_data_scale_df.Rdata")

#Save the values used to scaled
save(scale_env_value_new_cli,file="C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Climatic_data/new_selection/scale_env_value_new_cli.Rdata",force=T)
save(center_env_value_new_cli,file="C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Climatic_data/new_selection/center_env_value_new_cli.Rdata",force=T)
```


## Present

```{r present data}
#Scale 
load("C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Climatic_data/new_selection/scale_env_value_new_cli.Rdata")
load("C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Climatic_data/new_selection/center_env_value_new_cli.Rdata")

Present_climatic_data_T_adapcon_gentree_scaled <- data.frame(Present_new_6_Climatic_data_scale[,c(1,2)],scale(Present_new_6_Climatic_data_scale[,-c(1,2)], center = center_env_value_new_cli, scale = scale_env_value_new_cli))
```

The raster containing the standardised climatic variables was saved for use in the RDA-based Genomic Offset analysis
```{r save present raster for GO RDA, include=FALSE}
#Raster
present_climatic_data_raster <- ras.bio_present
save(present_climatic_data_raster,file="C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Genomic_offset/RDA/present_climatic_data_raster.Rdata")
#Dataframe
write_xlsx(Present_climatic_data_T_adapcon_gentree_scaled ,path="C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/validation_GO/climatic_data/Present_climatic_data_T_adapcon_gentree_scaled.xlsx")
```

## Future data

### Data frame format

Finally, future climatic data were scaled using the mean and standard deviation of the past climatic data. 
```{r normalize and save the future data}

for(x in 1:length(list_models)){
  
  model <- list_models[x]
  data <- get(paste0("Future_data_",model))
  data_final <- data.frame(data[,c(1:3,6:8,4,5)])
  colnames(data_final) <- c("Population","Country","Annual_Tc","Diurnal_range_Tc","Tc_Seasonality","Tc_driest_quarter","Annual_P","P_Seasonality")

Future_climatic_data_scaled <- data.frame(data_final[,c(1,2)],scale(data_final[,-c(1,2)], center = center_env_value_new_cli, scale = scale_env_value_new_cli))

assign(paste0("future_climatic_data_",model),data_final)
assign(paste0("future_climatic_data_scaled_",model),Future_climatic_data_scaled)

#Non scaled
write_xlsx(get(paste0("future_climatic_data_", model)),paste0("C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Climatic_data/new_selection/future_climatic_data_",model,".xlsx"))

#Save scale df
write_xlsx(get(paste0("future_climatic_data_scaled_",model)),paste0("C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Climatic_data/new_selection/future_climatic_data_scaled_",model,".xlsx"))
save(list=paste0("future_climatic_data_scaled_",model),file=paste0("C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Climatic_data/new_selection/future_climatic_data_scaled_",model,".Rdata"))
}
```


### Raster format

Next, we loaded the folder containing raster files and created a raster stack for all climatic variables for each climatic model.
```{r create the file with six rasters and save file}

for(x in 1:length(list_models)){
  
  model <- list_models[x]

future_climatic_data_raster <- stack(list.files(paste0("C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/Future_climate/2041_2070_",model,"_ssp370/"), pattern = ".tif$", full.names = T)) 

future_climatic_data <- data.frame(meta_data_pop$Population,raster::extract(future_climatic_data_raster, coords))#Important to add raster:: 
#Names of the raster (because they are not in the classic order Bio 1, 2 etc they are order by number so bio 1, 10, 11 etc)
names(future_climatic_data_raster) <- unlist(strsplit(unlist(lapply(strsplit(list.files(paste0("C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/Future_climate/2041_2070_",model,"_ssp370/"), pattern = ".tif$", full.names = T), split = paste0("C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/Future_climate/2041_2070_",model,"_ssp370/")), function(x) x[2])), split = ".tif"))

assign(paste0("future_climatic_data_raster_",model),future_climatic_data_raster)

#Save file
save(list=paste0("future_climatic_data_raster_",model),file=paste0("C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Genomic_offset/RDA/future_climatic_data_raster_",model,".Rdata"),F=T)
}
```


## LFMM analysis

For the LFMM analysis, we created a data frame containing climatic values at the individual level. Individuals from the same population were assigned identical climatic values, as LFMM operates at the individual level.

```{r new climatic matrix at individual-level}
#Load meta_data at individual level

climatic_data_indivdual_level_new_selection <- merge(meta_data_vcf[,-2],past_climatic_data_order[,c(1:4,6,10,12,15)],"Population")

climatic_data_indivdual_level_scaled_new_selection <- climatic_data_indivdual_level_new_selection[,-c(1:3)] %>% 
  scale()

climatic_data_indivdual_level_scaled_new_selection_df <- data.frame(climatic_data_indivdual_level_new_selection[,c(1:3)],climatic_data_indivdual_level_scaled_new_selection)

#Rename columns
colnames(climatic_data_indivdual_level_scaled_new_selection_df) <- c("Population","VCF_ID","Country","Annual_Tc","Diurnal_range_Tc","Tc_Seasonality","Tc_driest_quarter","Annual_P","P_Seasonality")
```

```{r save LFMM data, include=FALSE}
write_xlsx(climatic_data_indivdual_level_scaled_new_selection_df,"C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/climatic_data_indivdual_level_scaled_new_selection_df.xlsx")
save(climatic_data_indivdual_level_scaled_new_selection_df,file="C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Climatic_data/new_selection/climatic_data_indivdual_level_scaled_new_selection_df.Rdata")
```


# Comparison of the climatic envelope of *T. baccata*: European range vs. sampled population

We compared the climatic envelope, using the six climatic variables retained for the past period, between the 29 populations and the occurrence points of *T. baccata* across Europe. 

## Shapefile 

### Climatic data presence data

Load shapefile presence data
```{r presence data}
presence_shp <- st_read("C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/shapefiles/presence_point_europe/euforgen.shp")
```

We extracted coordinates from the shapefile (SHP) to enable retrieval of climatic data from the corresponding raster layers. 
```{r coord data}
df_coord_data <- data.frame(Longitude=presence_shp$LONG_WGS84,Latitude=presence_shp$LAT_WGS84)
```

Extract climatic data
```{r extract the climatic data}
#First we need to extract the climatic data
df_coord_data$Longitude <- as.numeric(df_coord_data$Longitude);df_coord_data$Latitude <- as.numeric(df_coord_data$Latitude)

#Raster
ras.bio <- stack(list.files("C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/1901-1950_raster/", pattern = ".tif$", full.names = T)) 
#Names of the raster (because they are not in the classic order Bio 1, 2 etc they are order by number so bio 1, 10, 11 etc)
names(ras.bio) <- unlist(strsplit(unlist(lapply(strsplit(list.files("C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/1901-1950_raster/", pattern = ".tif$", full.names = T), split = "C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/1901-1950_raster/"), function(x) x[2])), split = ".tif"))

#We extracted the climatic values for each populations from the raster based on their coordinates
clim_shp <- data.frame(raster::extract(ras.bio, df_coord_data))#Important to add raster:: because this function is also in tidyr and will not do the same things
colnames(clim_shp)<- c(names(ras.bio))

final_df_presence_shp <- clim_shp[-5,c(2,11,13,17,4,7)]

final_df_presence_shp$group <- "range-wide"
```


### Combine datasets and scale climatic variables for comparability across periods and populations

```{r climatic data 29pop}
Past_clim_data_Europe_pop
#Past_clim_data_Europe_pop$group <- c("I","CH","SLO","N","E","E","E","UK","I","I","SLO","SK","CH","CH","GR","GR","GR","D","E","UK","F","S","F","E","SLO","I","BIH","CH","UK")
Past_clim_data_Europe_pop$group <- Past_clim_data_Europe_pop$Country
```

```{r combined df}
df_combined_clim <- rbind(final_df_presence_shp,Past_clim_data_Europe_pop[,-c(1,2)])

df_combined_clim_scaled <- df_combined_clim %>% dplyr::mutate(across(where(is.numeric), ~scale(.)))
```


### PCA
```{r PCA}
env_PCA <- PCA(df_combined_clim_scaled[,-c(7)], scale.unit = T,
        ncp = ncol(df_combined_clim_scaled[,-c(7)]),graph=F)

eigvalues<-round(env_PCA$eig,2);eigvalues
barplot(eigvalues[,2], xlab="Axis",ylab="Explained variance", main= "Scatterplot")
```


Add name of the 29 pop
```{r PCA plot}
meta_data_pop$pop_abbrev <- c("VIS","BAU","SDF","PAT","CHO","VOU","OLY","ANC","PDT","UMB","VAL","BRA","HAR","GOR","BOM","UNS","BUJA","BUJG","CAR","RAS","SUE","SAV","BLI","HHR","JUR","WAL","CED","RWM","YEW")

PC_scores<-data.frame(env_PCA$ind$coord[,c(1,2)],Group=df_combined_clim_scaled$group)
explained_var <- round(env_PCA$eig[,2],1)

group_palette <- c("range-wide"="grey","Bosnia"="orangered3", "France"="gold2","Germany"= "darkorchid3", "Greece"="navyblue", "Italy"="turquoise2", "Norway"="green3", "Slovakia"="blue", "Slovenia"="red", "Spain"="black", "Sweden"="pink", "Switzerland"="darkorange", "UK"="darkgreen")

data_name <- cbind(meta_data_pop[,c(1,2,7)],PC_scores[c(1016:1044),])

loadings <- as.data.frame(env_PCA$var$coord[, c(1, 2)]) #Loadings for PC1 and PC2
colnames(loadings) <- c("Dim.1", "Dim.2") #Rename columns
loadings$Variable <- rownames(loadings)  #Add variable names

PCA_plot <- ggplot(PC_scores, aes(x = Dim.1, y = Dim.2, col = Group)) +
  geom_point(size = 2.5, alpha = 0.5) + 
  scale_color_manual(name = "Group", values = group_palette) + 
  xlab(paste0("PC 1 (", explained_var[1], "%)")) + 
  ylab(paste0("PC 2 (", explained_var[2], "%)")) +
  ggtitle("Climatic PCA") +
  geom_segment(data = loadings, aes(x = 0, y = 0, xend = Dim.1*5, yend = Dim.2*5),
               arrow = arrow(length = unit(0.2, "cm")), color = "black", size = 0.5) + 
  geom_text(data = loadings, aes(x = Dim.1, y = Dim.2, label = Variable), 
            color = "black", hjust = 0.5, vjust = -0.5, size = 3.5) +
  guides(color = guide_legend(title = "Group")) +
  theme_bw(base_size = 11) +
  theme(legend.position = "right", 
        panel.grid = element_blank(), 
        strip.text = element_text(size = 11), 
        plot.title = element_text(hjust = 0.5, color = "black", face = "italic"))

print(PCA_plot)
pdf("C:/Users/tfrancisco/Documents/Thesis/Results/species/taxus/climate/Comparison_climate/PCA_presencepointeurope_pop_color.pdf");print(PCA_plot);dev.off()


PCA_plot <- ggplot(PC_scores, aes(x = Dim.1, y = Dim.2, col = Group)) +
  geom_point(size = 2, alpha = 0.5) + 
  scale_color_manual(name = "Group", values = group_palette) + 
  xlab(paste0("PC 1 (", explained_var[1], "%)")) + 
  ylab(paste0("PC 2 (", explained_var[2], "%)")) +
  ggtitle("Climatic PCA") +
  geom_segment(data = loadings, aes(x = 0, y = 0, xend = Dim.1*5, yend = Dim.2*5),
               arrow = arrow(length = unit(0.2, "cm")), color = "darkgreen", size = 0.5) + 
  geom_text(data = loadings, aes(x = Dim.1, y = Dim.2, label = Variable), 
            color = "darkgreen", hjust = 0.5, vjust = -0.5, size = 3.5) +
  geom_text(data=data_name, aes(x = Dim.1, y = Dim.2-0.2, label= pop_abbrev), color = "black",size = 3) +
  guides(color = guide_legend(title = "Group")) +
  theme_bw(base_size = 11) +
  theme(legend.position = "right", 
        panel.grid = element_blank(), 
        strip.text = element_text(size = 11), 
        plot.title = element_text(hjust = 0.5, color = "black", face = "italic"))

print(PCA_plot)

pdf("C:/Users/tfrancisco/Documents/Thesis/Results/species/taxus/climate/Comparison_climate/PCA_presencepointeurope_pop_name.pdf");print(PCA_plot);dev.off()
```

## CG+SNP+SSR populations

One limitation of the EUFORGEN map is that the presence data include potential planted populations, particularly in central France, as well as populations outside the natural distribution of *T. baccata*, such as in northern UK. Additionally, the distribution shown in the EUFORGEN map appears continuous, whereas the natural distribution of Taxus baccata is highly fragmented. To obtain more precise presence data, we used the coordinates of the 29 SNP-sampled populations, the 26 clonal garden (CG) populations, and the 242 populations sampled for SSR, and compared these with the 29 SNP populations.

### Gather the data
```{r combined CG SNP SSR}
#Spain data
load("C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Climatic_data/Spain_pop/Past_clim_data_Spain_pop.Rdata")

#UE data
load("C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Climatic_data/new_selection/Past_clim_data_Europe_pop.Rdata")

df_2dataset <- rbind(Past_clim_data_Europe_pop[,c(1,3:8)],Past_clim_data_Spain_pop[,c(1,3:8)])
```

### Extract climatic data for SSR pop

```{r SSR pop}
SRR_pop_data <- read.csv("C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Migration/Meta_data_pop_taxus_migration.csv",h=T,sep=";",dec=",")
```

```{r coord data SRR}
df_coord_data_SSR <- data.frame(Longitude=SRR_pop_data$LONG,Latitude=SRR_pop_data$LAT)
```

Extract climatic data

```{r extract the climatic data SSR}
#First we need to extract the climatic data
df_coord_data_SSR$Longitude <- as.numeric(df_coord_data_SSR$Longitude);df_coord_data_SSR$Latitude <- as.numeric(df_coord_data_SSR$Latitude)

#Raster
ras.bio <- stack(list.files("C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/1901-1950_raster/", pattern = ".tif$", full.names = T)) 
#Names of the raster (because they are not in the classic order Bio 1, 2 etc they are order by number so bio 1, 10, 11 etc)
names(ras.bio) <- unlist(strsplit(unlist(lapply(strsplit(list.files("C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/1901-1950_raster/", pattern = ".tif$", full.names = T), split = "C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/1901-1950_raster/"), function(x) x[2])), split = ".tif"))

#We extracted the climatic values for each populations from the raster based on their coordinates
clim_SSR <- data.frame(raster::extract(ras.bio, df_coord_data_SSR))#Important to add raster:: because this function is also in tidyr and will not do the same things
colnames(clim_SSR)<- c(names(ras.bio))

final_df_presence_SSR <- clim_SSR[-5,c(2,11,13,17,4,7)]
```

Gather with other dataframe
```{r gather three df}
df_3dataset <- rbind(df_2dataset[,-1],final_df_presence_SSR)

df_3dataset$group <- "range-wide"

Past_clim_data_Europe_pop$group <- Past_clim_data_Europe_pop$Country

df_combined_clim <- rbind(df_3dataset,Past_clim_data_Europe_pop[,-c(1,2)])

df_combined_clim_scaled_reduce <- df_combined_clim %>% dplyr::mutate(across(where(is.numeric), ~scale(.)))
```

```{r PCA 3df}
env_PCA_reduce <- PCA(df_combined_clim_scaled_reduce[,-c(7)], scale.unit = T,
        ncp = ncol(df_combined_clim_scaled_reduce[,-c(7)]),graph=F)

eigvalues<-round(env_PCA_reduce$eig,2);eigvalues
barplot(eigvalues[,2], xlab="Axis",ylab="Explained variance", main= "Scatterplot")
```
```{r}
meta_data_pop_order <- meta_data_pop[order(meta_data_pop$Population),]

#meta_data_poppop_abbrev <- c("VIS","BAU","SDF","PAT","CHO","VOU","OLY","ANC","PDT","UMB","VAL","BRA","HAR","GOR","BOM","UNS","BUJA","BUJG","CAR","RAS","SUE","SAV","BLI","HHR","JUR","WAL","CED","RWM","YEW")

meta_data_pop_order$pop_abbrev <- c("ANC","BLI","BOM","BRA","BUJA","BUJG","CAR","CED","PDT","UMB","GOR","HAR","HHR","JUR","CHO","OLY","VOU","PAT","RAS","RWM","BAU","SAV","SDF","SUE","UNS","VAL","VIS","WAL","YEW")

PC_scores<-data.frame(env_PCA_reduce$ind$coord[,c(1,2)],Group=df_combined_clim_scaled_reduce$group)
explained_var <- round(env_PCA_reduce$eig[,2],1)

group_palette <- c("range-wide"="grey","Bosnia"="orangered3", "France"="gold2","Germany"= "darkorchid3", "Greece"="navyblue", "Italy"="turquoise2", "Norway"="green3", "Slovakia"="blue", "Slovenia"="red", "Spain"="black", "Sweden"="pink", "Switzerland"="darkorange", "UK"="darkgreen")

data_name <- cbind(meta_data_pop_order[,c(1,2,7)],PC_scores[c(305:333),])

loadings <- as.data.frame(env_PCA_reduce$var$coord[, c(1, 2)]) # Loadings for PC1 and PC2
colnames(loadings) <- c("Dim.1", "Dim.2") # Rename columns
loadings$Variable <- rownames(loadings)  # Add variable names

PCA_plot <- ggplot(PC_scores, aes(x = Dim.1, y = Dim.2, col = Group)) +
  geom_point(size = 2.5, alpha = 0.5) + 
  scale_color_manual(name = "Group", values = group_palette) + 
  xlab(paste0("PC 1 (", explained_var[1], "%)")) + 
  ylab(paste0("PC 2 (", explained_var[2], "%)")) +
  ggtitle("Climatic PCA") +
  geom_segment(data = loadings, aes(x = 0, y = 0, xend = Dim.1*5, yend = Dim.2*5),
               arrow = arrow(length = unit(0.2, "cm")), color = "black", size = 0.5) + 
  geom_text(data = loadings, aes(x = Dim.1, y = Dim.2, label = Variable), 
            color = "black", hjust = 0.5, vjust = -0.5, size = 3.5) +
  guides(color = guide_legend(title = "Group")) +
  theme_bw(base_size = 11) +
  theme(legend.position = "right", 
        panel.grid = element_blank(), 
        strip.text = element_text(size = 11), 
        plot.title = element_text(hjust = 0.5, color = "black", face = "italic"))

print(PCA_plot)
#pdf("C:/Users/tfrancisco/Documents/Thesis/Results/species/taxus/climate/Comparison_climate/PCA_presencepointeurope_pop_color.pdf");print(PCA_plot);dev.off()

PCA_plot <- ggplot(PC_scores, aes(x = Dim.1, y = Dim.2, col = Group)) +
  geom_point(size = 2, alpha = 0.5) + 
  scale_color_manual(name = "Group", values = group_palette) + 
  xlab(paste0("PC 1 (", explained_var[1], "%)")) + 
  ylab(paste0("PC 2 (", explained_var[2], "%)")) +
  ggtitle("Climatic PCA") +
  #geom_segment(data = loadings, aes(x = 0, y = 0, xend = Dim.1*5, yend = Dim.2*5),
               #arrow = arrow(length = unit(0.2, "cm")), color = "darkgreen", size = 0.5) + 
  #geom_text(data = loadings, aes(x = Dim.1, y = Dim.2, label = Variable), 
            #color = "darkgreen", hjust = 0.5, vjust = -0.5, size = 3.5) +
  geom_text(data=data_name, aes(x = Dim.1, y = Dim.2-0.2, label= pop_abbrev), color = "black",size = 3) +
  guides(color = guide_legend(title = "Group")) +
  theme_bw(base_size = 11) +
  theme(legend.position = "right", 
        panel.grid = element_blank(), 
        strip.text = element_text(size = 11), 
        plot.title = element_text(hjust = 0.5, color = "black", face = "italic"))

print(PCA_plot)

pdf("C:/Users/tfrancisco/Documents/Thesis/Results/species/taxus/climate/Comparison_climate/PCA_reducenumberpopspacetosampledpop.pdf");print(PCA_plot);dev.off()
```



**What is below is a draft for future climatic data that might be useful but was not used in this study**

```{r data_to_be_used_raster future, eval=FALSE, include=FALSE}
Future_clim_data <- data.frame(merge(meta_data_pop[,c(2,4,5)],Future_climatic_data_T_adapcon_gentree[,c(1,3,7,8,4:6)],"Population"))
# we need to rename colnames for raster
Future_clim_data$Latitude <- as.numeric(Future_clim_data$Latitude);Future_clim_data$Longitude <- as.numeric(Future_clim_data$Longitude)
Future_clim_data_new <- data.frame(Future_clim_data[,c(3,2)],Future_clim_data[,c(4:9)])

colnames(Future_clim_data_new) <- c('x', 'y',"bio1", "bio12", "bio15","bio2","bio4","bio9")
```

```{r rasterization, eval=FALSE, include=FALSE}
# create a raster object with the extent of the data
r_obj <- raster(xmn=min(Future_clim_data_new$x)-0.1, xmx=max(Future_clim_data_new$x)+0.1, ymn=min(Future_clim_data_new$y)-0.1, ymx=max(Future_clim_data_new$y)+0.1, resolution=c(0.01,0.01)) #the resolution is smaller than what we have in meta_data_pop

# use rasterize to create desired raster with the pop and their values
future_climatic_data_raster <- rasterize(x=Future_clim_data_new[, 1:2], # lon-lat data
                    y=r_obj, # raster object
                    field=Future_clim_data_new[, 3:8], # clim var to fill raster with
                    fun=mean) # aggregate function
```

```{r save raster futut data, eval=FALSE, include=FALSE}
save(future_climatic_data_raster,file="C:/Users/tfrancisco/Documents/Thesis/Data/Species/Taxus_baccata/Genomic_offset/RDA/future_climatic_data_raster.Rdata",F=T)
```

Mean values future climatic data
```{r mean values across climatic models, eval=FALSE, include=FALSE}

for (x in 1: length(list_dataset)){
  var <- list_climatic_var[x]
   dataset <- get(list_dataset[x]) 

df <- dataset %>%
  mutate(mean_values=rowMeans(dplyr::select(., 3:7)))

df_f <- df[,c(1,2,8)]
colnames(df_f) <- c("Population","Country",paste0("mean_values_",var))

assign(paste0("df_",var,"_mean"),df_f)
}
```

```{r merge in 1 dataframe, eval=FALSE, include=FALSE}

Future_climatic_data_T_adapcon_gentree<- data.frame(Population=df_bio1_mean[,1],Country=df_bio1_mean[,2],Annual_Tc=df_bio1_mean[,3],Diurnal_range_Tc=df_bio2_mean[,3],Tc_Seasonality=df_bio4_mean[,3],Tc_driest_quarter=df_bio9_mean[,3],Annual_P=df_bio12_mean[,3],P_Seasonality=df_bio15_mean[,3])
```

The raster needs to be the mean value of the 5 climatic models 
```{r create 1 list for each bio from each models, eval=FALSE, include=FALSE}
library(raster)

#List of climatic variables
list_climatic_var <- c("bio1", "bio2","bio4", "bio9","bio12","bio15")  # Add more variables as needed

# List of climatic models
list_models <- c("GFDL_ESM4", "IPSL_CM6A_LR", "MPI_ESM1_2_HR", "MRI_ESM2_0", "UKESM1_0_LL")

# Create empty lists to store rasters for each variable
bio1_rasters <- list()
bio2_rasters <- list()
bio4_rasters <- list()
bio9_rasters <- list()
bio12_rasters <- list()
bio15_rasters <- list()

for (var_clim in list_climatic_var) {
  for (model in list_models) {
    # Create file path
    file_path <- paste0("C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/Future_climate/2041_2070_", model, "_ssp370/", var_clim, ".tif")
    
    # Read raster
    raster_data <- raster(file_path)
    
    # Store raster in corresponding list based on variable
    if (var_clim == "bio1") {
      bio1_rasters[[model]] <- raster_data
    } else if (var_clim == "bio2") {
      bio2_rasters[[model]] <- raster_data
    } else if (var_clim == "bio4
               ") {
      bio4_rasters[[model]] <- raster_data
    } else if (var_clim == "bio9") {
      bio9_rasters[[model]] <- raster_data
    } else if(var_clim =="bio12"){
      bio12_rasters[[model]] <- raster_data
    } else if(var_clim =="bio15"){
      bio15_rasters[[model]] <- raster_data
    }
  }
}

```

```{r calculate mean raster, eval=FALSE, include=FALSE}

calculate_mean_raster <- function(raster_list) {
  raster_stack <- stack(raster_list)
  mean_raster <- calc(raster_stack, mean)
  return(mean_raster)
}

list_raster_to_mean <- c("bio1_rasters","bio2_rasters","bio4_rasters","bio9_rasters","bio12_rasters","bio15_rasters")
name_file <- c("bio1","bio2","bio4","bio9","bio12","bio15")
for(x in 1:length(list_raster_to_mean)){
  
  var <- get(list_raster_to_mean[x])
  # Calculate mean raster for each climatic variable
mean_bio <- calculate_mean_raster(var)
name_file_use <- name_file[x]

assign(name_file_use,mean_bio)  
}
```

```{r save raster mean file, eval=FALSE, include=FALSE}
for(x in 1:length(name_file)){
  var <- name_file[x]
  writeRaster(get(var), paste0("C:/Users/tfrancisco/Documents/Thesis/Data/Climatic/Mean_future_raster/",var), format="GTiff")
}
```

